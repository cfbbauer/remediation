param (
    [string]$logfolder
)

$dateTime = Get-Date -Format "yyyy-MM-dd HH:mm:ss"

Write-Host "Starting script at $dateTime"

if (!$logfolder) {
    $logfolder = "c:\Temp"
    Write-Host "`n`nParameter is null or empty.  Using c:\Temp directory for logfile.`n"

    if (!(Test-Path -Path $logfolder)) {
        New-Item -ItemType Directory -Path $logfolder
        Write-Host "Logging folder '$logfolder' created successfully.`n"
        } else {
        Write-Host "Logging folder '$logfolder' already exists.`n"
    }
}

$logfile = "$logfolder\remediate-CV-2024-7264-logfile.log"

Start-Transcript -Path $logfile

Write-Host "`n   Script is being run as the user shown below:"
whoami /user

Write-Host "`n   Starting to remediate CVE-2024-7264 on computer $env:computername `n"


$startingPath = "c:\Program Files"
Write-Host "Starting recursive search in folder: $startingPath `n"

$folderName = "Salesforce"
$folderPath = Get-ChildItem -Force -Path $startingPath -Directory -Filter $folderName -Recurse -ErrorAction SilentlyContinue
$completePath = $($folderPath.FullName)

if ($folderPath) {
    Write-Host "Folder found: $completePath"
#    Remove-Item -Path $completePath -Recurse -Force
#    if ($?) { Write-host "Folder removed: $completePath`n"
#    } else {
#    Write-Host "Failure to delete directory: $completePath`n"
#    }
} else {
    Write-Host "Folder '$folderName' not found.`n"
}

$folderName = "Simba DocumentDB ODBC Driver"
$folderPath = Get-ChildItem -Force -Path $startingPath -Directory -Filter $folderName -Recurse -ErrorAction SilentlyContinue
$completePath = $($folderPath.FullName)

if ($folderPath) {
    Write-Host "Folder found: $completePath"
 #   Remove-Item -Path $completePath -Recurse -Force
 #   if ($?) { Write-host "Folder removed: $completePath`n"
 #   } else {
 #   Write-Host "Failure to delete directory: $completePath`n"
 #   }
} else {
    Write-Host "Folder '$folderName' not found.`n"
}

$folderName = "Simba Google BigQuery ODBC Driver"
$folderPath = Get-ChildItem -Force -Path $startingPath -Directory -Filter $folderName -Recurse -ErrorAction SilentlyContinue
$completePath = $($folderPath.FullName)

if ($folderPath) {
    Write-Host "Folder found: $completePath"
#    Remove-Item -Path $completePath -Recurse -Force
#        if ($?) { Write-host "Folder removed: $completePath`n"
#    } else {
#    Write-Host "Failure to delete directory: $completePath`n"
#    }
} else {
    Write-Host "Folder '$folderName' not found.`n"
}

$folderName = "Simba Hive ODBC Driver"
$folderPath = Get-ChildItem -Force -Path $startingPath -Directory -Filter $folderName -Recurse -ErrorAction SilentlyContinue
$completePath = $($folderPath.FullName)

if ($folderPath) {
    Write-Host "Folder found: $completePath"
 #   Remove-Item -Path $completePath -Recurse -Force
 #   if ($?) { Write-host "Folder removed: $completePath`n"
 #   } else {
 #   Write-Host "Failure to delete directory: $completePath`n"
 #   }
} else {
    Write-Host "Folder '$folderName' not found.`n"
}

$folderName = "Simba Impala ODBC Driver"
$folderPath = Get-ChildItem -Force -Path $startingPath -Directory -Filter $folderName -Recurse -ErrorAction SilentlyContinue
$completePath = $($folderPath.FullName)

if ($folderPath) {
    Write-Host "Folder found: $completePath"
#    Remove-Item -Path $completePath -Recurse -Force
#    if ($?) { Write-host "Folder removed: $completePath`n"
#    } else {
#    Write-Host "Failure to delete directory: $completePath`n"
#    }
} else {
    Write-Host "Folder '$folderName' not found.`n"
}

$folderName = "Simba QuickBooks ODBC Driver"
$folderPath = Get-ChildItem -Force -Path $startingPath -Directory -Filter $folderName -Recurse -ErrorAction SilentlyContinue
$completePath = $($folderPath.FullName)

if ($folderPath) {
    Write-Host "Folder found: $completePath"
#    Remove-Item -Path $completePath -Recurse -Force
#    if ($?) { Write-host "Folder removed: $completePath`n"
#    } else {
#    Write-Host "Failure to delete directory: $completePath`n"
#    }
} else {
    Write-Host "Folder '$folderName' not found.`n"
}

$folderName = "Simba Spark ODBC Driver"
$folderPath = Get-ChildItem -Force -Path $startingPath -Directory -Filter $folderName -Recurse -ErrorAction SilentlyContinue
$completePath = $($folderPath.FullName)

if ($folderPath) {
    Write-Host "Folder found: $completePath"
#    Remove-Item -Path $completePath -Recurse -Force
#    if ($?) { Write-host "Folder removed: $completePath`n"
#    } else {
#    Write-Host "Failure to delete directory: $completePath`n"
#    }
} else {
    Write-Host "Folder '$folderName' not found.`n"
}

Write-Host "`n  Validating contents after select directory deletions. `n"

$folderName = "ODBC Drivers"
$folderPaths = @(Get-ChildItem -Force -Path $startingPath -Directory -Filter $folderName -Recurse -ErrorAction SilentlyContinue).FullName
$itemCount = $folderPaths.Count
$count = 1

Write-Host '  Number of folders found named "ODBC Drivers" within "'$startingPath'" '$itemCount
Write-Host "`n"

foreach ($folder in $folderPaths) {
    write-host "Subdirectories found within folder $($count): "$folder
    $getsearchresult = Get-ChildItem -Force -Path $folder -Directory -ErrorAction SilentlyContinue

    if ($getsearchresult) {
        Write-Host ($getsearchresult -join "`n")
        Write-Host "`n"
    } else {
    Write-Host "-- No subdirectories found -- $getsearchresult `n"
    }
    
    $count++
}

$dateTime = Get-Date -Format "yyyy-MM-dd HH:mm:ss"

Write-Host "Ending script at $dateTime `n"

Stop-Transcript